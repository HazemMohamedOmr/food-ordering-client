import{a as J}from"./chunk-NZLYIASJ.js";import{a as K,b as X,c as Z}from"./chunk-3GKHYPM2.js";import{c as q,f as B,k as z,l as Y,m as Q,r as G}from"./chunk-4J4J2DGP.js";import{$ as g,F as y,G as O,Ia as V,P as l,Qa as L,R as P,Ra as R,S as A,Sa as H,W as f,Ya as U,ga as i,ha as t,hb as W,ia as b,ib as j,la as C,ma as h,na as u,ra as F,rb as $,sa as a,ta as I,ua as v,va as N,wa as T,xa as k,ya as D}from"./chunk-57XHIBD7.js";import{a as E,b as w}from"./chunk-AIZVJUQQ.js";function te(d,r){if(d&1){let e=C();i(0,"div",25),a(1),i(2,"button",26),h("click",function(){y(e);let o=u();return O(o.errorMessage="")}),t()()}if(d&2){let e=u();l(),v(" ",e.errorMessage," ")}}function re(d,r){if(d&1){let e=C();i(0,"div",27),a(1),i(2,"button",26),h("click",function(){y(e);let o=u();return O(o.successMessage="")}),t()()}if(d&2){let e=u();l(),v(" ",e.successMessage," ")}}function ie(d,r){d&1&&(i(0,"div",28)(1,"div",29)(2,"span",30),a(3,"Loading..."),t()()())}function ne(d,r){if(d&1&&(i(0,"option",31),a(1),t()),d&2){let e=r.$implicit,n=u();g("value",e.id)("disabled",n.restaurantsWithActiveOrders.has(e.id)),l(),N(" ",e.name,"",n.restaurantsWithActiveOrders.has(e.id)?" (Has Active Order)":""," ")}}function ae(d,r){d&1&&b(0,"span",32)}function se(d,r){d&1&&b(0,"span",32)}function de(d,r){if(d&1){let e=C();i(0,"div",33)(1,"div",34)(2,"div",35)(3,"h4",36),a(4,"Confirm Order Closure"),t(),i(5,"button",26),h("click",function(){y(e);let o=u();return O(o.cancelCloseOrder())}),t()(),i(6,"div",37)(7,"div",38),b(8,"i",39),a(9," Are you sure you want to close this order? "),t(),i(10,"p"),a(11,"This will finalize the order and prevent any further modifications."),t(),i(12,"div",40)(13,"p")(14,"strong"),a(15,"Order ID:"),t(),a(16),t(),i(17,"p")(18,"strong"),a(19,"Restaurant:"),t(),a(20),t(),i(21,"p")(22,"strong"),a(23,"Date:"),t(),a(24),t()()(),i(25,"div",41)(26,"button",42),h("click",function(){y(e);let o=u();return O(o.cancelCloseOrder())}),a(27,"Cancel"),t(),i(28,"button",43),h("click",function(){y(e);let o=u();return O(o.confirmCloseOrder())}),f(29,se,1,0,"span",18),a(30," Close Order "),t()()()()}if(d&2){let e=u();l(16),v(" ",e.orderToClose.id,""),l(4),v(" ",(e.orderToClose.restaurant==null?null:e.orderToClose.restaurant.name)||"N/A",""),l(4),v(" ",e.formatDate(e.orderToClose.orderDate),""),l(4),g("disabled",e.isProcessingClose),l(),g("ngIf",e.isProcessingClose)}}function oe(d,r){d&1&&(i(0,"div",49)(1,"div",29)(2,"span",30),a(3,"Loading details..."),t()()())}function le(d,r){if(d&1&&(i(0,"p")(1,"strong"),a(2,"Closed At:"),t(),a(3),t()),d&2){let e=u(3);l(3),v(" ",e.formatDate(e.selectedOrder.closedAt)," ")}}function me(d,r){if(d&1){let e=C();i(0,"button",70),h("click",function(){y(e);let o=u().$implicit,c=u(4);return O(c.updatePaymentStatus(c.selectedOrder.id,o,c.PaymentStatus.Paid))}),b(1,"i",71),a(2," Mark as Paid "),t()}if(d&2){let e=u(5);g("disabled",e.processingPayment)}}function ce(d,r){if(d&1){let e=C();i(0,"button",72),h("click",function(){y(e);let o=u().$implicit,c=u(4);return O(c.updatePaymentStatus(c.selectedOrder.id,o,c.PaymentStatus.Unpaid))}),b(1,"i",73),a(2," Mark as Unpaid "),t()}if(d&2){let e=u(5);g("disabled",e.processingPayment)}}function ue(d,r){if(d&1&&(i(0,"tr")(1,"td"),a(2),t(),i(3,"td"),a(4),t(),i(5,"td"),a(6),t(),i(7,"td"),a(8),t(),i(9,"td"),a(10),t()()),d&2){let e=r.$implicit;l(2),I((e.menuItem==null?null:e.menuItem.name)||"Unknown Item"),l(2),v("$",(e.menuItem==null||e.menuItem.price==null?null:e.menuItem.price.toFixed(2))||"0.00",""),l(2),I(e.quantity),l(2),v("$",(((e.menuItem==null?null:e.menuItem.price)||0)*e.quantity).toFixed(2),""),l(2),I(e.note||"-")}}function ge(d,r){if(d&1&&(i(0,"tr",74)(1,"td",75),a(2,"Delivery Fee (per user):"),t(),i(3,"td"),a(4),t(),i(5,"td"),a(6,"-"),t()()),d&2){let e=u().$implicit,n=u(4);l(4),v("$",n.selectedOrder.userItems[e].deliveryFee.toFixed(2),"")}}function _e(d,r){if(d&1&&(i(0,"div",59)(1,"div",60)(2,"div",61)(3,"h4",8),a(4),t(),i(5,"div")(6,"span",62),a(7),t(),f(8,me,3,1,"button",63)(9,ce,3,1,"button",64),t()(),i(10,"div",9)(11,"div",65)(12,"table",66)(13,"thead")(14,"tr")(15,"th"),a(16,"Item"),t(),i(17,"th"),a(18,"Price"),t(),i(19,"th"),a(20,"Quantity"),t(),i(21,"th"),a(22,"Total"),t(),i(23,"th"),a(24,"Note"),t()()(),i(25,"tbody"),f(26,ue,11,5,"tr",67)(27,ge,7,1,"tr",68),t(),i(28,"tfoot")(29,"tr")(30,"th",69),a(31,"Subtotal:"),t(),i(32,"th"),a(33),t(),b(34,"th"),t()()()()()()()),d&2){let e=r.$implicit,n=u(4);l(4),I(n.selectedOrder.userItems[e].userName),l(2),g("ngClass",n.selectedOrder.userItems[e].isPaid?"bg-success":"bg-danger"),l(),v(" ",n.selectedOrder.userItems[e].isPaid?"Paid":"Unpaid"," "),l(),g("ngIf",n.selectedOrder.status===n.OrderStatus.Closed&&!n.selectedOrder.userItems[e].isPaid),l(),g("ngIf",n.selectedOrder.status===n.OrderStatus.Closed&&n.selectedOrder.userItems[e].isPaid),l(17),g("ngForOf",n.selectedOrder.userItems[e].items),l(),g("ngIf",n.selectedOrder.userItems[e].deliveryFee>0),l(6),v("$",n.selectedOrder.userItems[e].totalAmount.toFixed(2),"")}}function ve(d,r){if(d&1&&(i(0,"tr")(1,"th"),a(2,"Delivery Fee:"),t(),i(3,"td",57),a(4),t()()),d&2){let e=u(4);l(4),v("$",e.selectedOrder.deliveryFee.toFixed(2),"")}}function fe(d,r){if(d&1&&(i(0,"div"),f(1,_e,35,8,"div",52),i(2,"div",53)(3,"div",54)(4,"h4",8),a(5,"Order Summary"),t()(),i(6,"div",9)(7,"div",10)(8,"div",55)(9,"table",56)(10,"tbody")(11,"tr")(12,"th"),a(13,"Items Total:"),t(),i(14,"td",57),a(15),t()(),f(16,ve,5,1,"tr",21),i(17,"tr",58)(18,"th"),a(19,"Total Amount:"),t(),i(20,"td",57),a(21),t()()()()()()()()()),d&2){let e=u(3);l(),g("ngForOf",e.Object.keys(e.selectedOrder.userItems)),l(14),v("$",(e.selectedOrder.totalAmount-(e.selectedOrder.deliveryFee||0)).toFixed(2),""),l(),g("ngIf",e.selectedOrder.deliveryFee),l(5),v("$",e.selectedOrder.totalAmount==null?null:e.selectedOrder.totalAmount.toFixed(2),"")}}function pe(d,r){d&1&&(i(0,"div",76),a(1," No items found for this order. "),t())}function he(d,r){if(d&1&&(i(0,"div")(1,"div",50)(2,"div",10)(3,"div",11)(4,"p")(5,"strong"),a(6,"Order ID:"),t(),a(7),t(),i(8,"p")(9,"strong"),a(10,"Restaurant:"),t(),a(11),t()(),i(12,"div",11)(13,"p")(14,"strong"),a(15,"Date:"),t(),a(16),t(),f(17,le,4,1,"p",21),t()()(),i(18,"h3",12),a(19,"Order Items by User"),t(),f(20,fe,22,4,"div",51)(21,pe,2,0,"ng-template",null,0,V),t()),d&2){let e=F(22),n=u(2);l(7),v(" ",n.selectedOrder.id,""),l(4),v(" ",(n.selectedOrder.restaurant==null?null:n.selectedOrder.restaurant.name)||"N/A",""),l(5),v(" ",n.formatDate(n.selectedOrder.orderDate),""),l(),g("ngIf",n.selectedOrder.status===n.OrderStatus.Closed),l(3),g("ngIf",n.selectedOrder.userItems&&n.Object.keys(n.selectedOrder.userItems).length>0)("ngIfElse",e)}}function xe(d,r){if(d&1){let e=C();i(0,"button",77),h("click",function(){y(e);let o=u(2);return O(o.showCloseOrderConfirmation(o.selectedOrder))}),a(1," Close Order "),t()}}function ye(d,r){if(d&1){let e=C();i(0,"div",44)(1,"div",45)(2,"div",35)(3,"h2",36),a(4," Order Details "),i(5,"span",46),a(6),t()(),i(7,"button",26),h("click",function(){y(e);let o=u();return O(o.clearSelectedOrder())}),t()(),i(8,"div",37),f(9,oe,4,0,"div",47)(10,he,23,6,"div",21),t(),i(11,"div",41)(12,"button",42),h("click",function(){y(e);let o=u();return O(o.clearSelectedOrder())}),a(13,"Close"),t(),f(14,xe,2,0,"button",48),t()()()}if(d&2){let e=u();l(5),g("ngClass",e.getOrderStatusClass(e.selectedOrder.status)),l(),v(" ",e.getOrderStatusName(e.selectedOrder.status)," "),l(3),g("ngIf",e.isLoadingDetails),l(),g("ngIf",!e.isLoadingDetails),l(4),g("ngIf",e.selectedOrder.status===e.OrderStatus.Open)}}function Oe(d,r){d&1&&(i(0,"div",76),a(1," No active orders found. "),t())}function Ie(d,r){if(d&1){let e=C();i(0,"tr")(1,"td"),a(2),t(),i(3,"td"),a(4),t(),i(5,"td"),a(6),t(),i(7,"td"),a(8),t(),i(9,"td")(10,"div",83)(11,"button",84),h("click",function(){let o=y(e).$implicit,c=u(3);return O(c.viewOrderDetails(o))}),b(12,"i",85),a(13," View Details "),t(),i(14,"button",86),h("click",function(){let o=y(e).$implicit,c=u(3);return O(c.showCloseOrderConfirmation(o))}),b(15,"i",87),a(16," Close Order "),t()()()()}if(d&2){let e=r.$implicit,n=u(3);l(2),I(e.id),l(2),I((e.restaurant==null?null:e.restaurant.name)||"N/A"),l(2),I(n.formatDate(e.orderDate)),l(2),I(e.managerName)}}function be(d,r){if(d&1&&(i(0,"div",65)(1,"table",82)(2,"thead")(3,"tr")(4,"th"),a(5,"Order ID"),t(),i(6,"th"),a(7,"Restaurant"),t(),i(8,"th"),a(9,"Date"),t(),i(10,"th"),a(11,"Created By"),t(),i(12,"th"),a(13,"Actions"),t()()(),i(14,"tbody"),f(15,Ie,17,4,"tr",67),t()()()),d&2){let e=u(2);l(15),g("ngForOf",e.activeOrders)}}function Ce(d,r){d&1&&(i(0,"div",76),a(1," No order history found. "),t())}function Se(d,r){if(d&1){let e=C();i(0,"tr")(1,"td"),a(2),t(),i(3,"td"),a(4),t(),i(5,"td"),a(6),t(),i(7,"td"),a(8),t(),i(9,"td"),a(10),t(),i(11,"td")(12,"button",84),h("click",function(){let o=y(e).$implicit,c=u(3);return O(c.viewOrderDetails(o))}),b(13,"i",85),a(14," View Details "),t()()()}if(d&2){let e=r.$implicit,n=u(3);l(2),I(e.id),l(2),I((e.restaurant==null?null:e.restaurant.name)||"N/A"),l(2),I(n.formatDate(e.orderDate)),l(2),I(n.formatDate(e.closedAt)),l(2),I(e.managerName)}}function Me(d,r){if(d&1&&(i(0,"div",65)(1,"table",82)(2,"thead")(3,"tr")(4,"th"),a(5,"Order ID"),t(),i(6,"th"),a(7,"Restaurant"),t(),i(8,"th"),a(9,"Date"),t(),i(10,"th"),a(11,"Closed At"),t(),i(12,"th"),a(13,"Created By"),t(),i(14,"th"),a(15,"Actions"),t()()(),i(16,"tbody"),f(17,Se,15,5,"tr",67),t()()()),d&2){let e=u(2);l(17),g("ngForOf",e.orderHistory)}}function Ee(d,r){if(d&1&&(i(0,"div")(1,"div",6)(2,"div",78)(3,"h2",8),a(4,"Active Orders"),t()(),i(5,"div",9),f(6,Oe,2,0,"div",79)(7,be,16,1,"div",80),t()(),i(8,"div",60)(9,"div",81)(10,"h2",8),a(11,"Order History"),t()(),i(12,"div",9),f(13,Ce,2,0,"div",79)(14,Me,18,1,"div",80),t()()()),d&2){let e=u();l(6),g("ngIf",e.activeOrders.length===0),l(),g("ngIf",e.activeOrders.length>0),l(6),g("ngIf",e.orderHistory.length===0),l(),g("ngIf",e.orderHistory.length>0)}}var ee=class d{constructor(r,e,n,o){this.orderService=r;this.authService=e;this.restaurantService=n;this.router=o}activeOrders=[];orderHistory=[];isLoading=!1;errorMessage="";successMessage="";selectedOrder=null;isLoadingDetails=!1;orderToClose=null;isProcessingClose=!1;processingPayment=!1;managedRestaurants=[];selectedRestaurantId="";isCreatingOrder=!1;OrderStatus=K;PaymentStatus=X;Object=Object;restaurantsWithActiveOrders=new Set;ngOnInit(){if(!this.authService.isLoggedIn||!this.authService.isManager){this.router.navigate(["/"]);return}this.loadRestaurants(),this.loadActiveOrders(),this.loadOrderHistory()}loadRestaurants(){this.restaurantService.getAll().subscribe({next:r=>{this.managedRestaurants=r},error:r=>{this.errorMessage=r.message||"Failed to load restaurants"}})}loadActiveOrders(){this.isLoading=!0,this.errorMessage="",this.orderService.getActiveOrders().subscribe({next:r=>{let e=r.map(o=>w(E({},o),{id:o.id,restaurant:{id:"",name:o.restaurantName||"N/A",description:"",address:"",phoneNumber:"",deliveryFee:o.deliveryFee||0},restaurantId:o.restaurantId||"",managerId:"",managerName:o.managerName||"",status:o.status,orderDate:o.orderDate,closedAt:o.closedAt,deliveryFee:o.deliveryFee})),n=this.authService.currentUser?.name;n&&(e=e.filter(o=>o.managerName===n)),this.activeOrders=e,this.restaurantsWithActiveOrders.clear(),r.forEach(o=>{o.restaurantId&&this.restaurantsWithActiveOrders.add(o.restaurantId)}),console.log("Filtered active orders for manager:",this.activeOrders),console.log("Restaurants with active orders:",this.restaurantsWithActiveOrders),this.isLoading=!1},error:r=>{this.isLoading=!1,this.errorMessage=r.message||"Failed to load active orders"}})}loadOrderHistory(){this.isLoading=!0,this.errorMessage="",this.orderService.getOrderHistory().subscribe({next:r=>{let e=r.map(s=>w(E({},s),{id:s.id,restaurant:{id:"",name:s.restaurantName||"N/A",description:"",address:"",phoneNumber:"",deliveryFee:s.deliveryFee||0},restaurantId:"",managerId:"",managerName:s.managerName||"",status:s.status,orderDate:s.orderDate,closedAt:s.closedAt,deliveryFee:s.deliveryFee})),n=this.authService.currentUser?.name;n&&(e=e.filter(s=>s.managerName===n)),this.orderHistory=e,console.log("Filtered order history for manager:",this.orderHistory);let o=this.orderHistory.filter(s=>s.status===2),c=0,m=o.length;if(m===0){this.isLoading=!1;return}o.forEach(s=>{this.orderService.getOrderPaymentStatuses(s.id).subscribe({next:_=>{if(_&&_.userPayments&&Array.isArray(_.userPayments)){let S={};_.userPayments.forEach(p=>{S[p.userId]=p.status===2});let x=this.orderHistory.findIndex(p=>p.id===s.id);x!==-1&&(this.orderHistory[x].userItems||(this.orderHistory[x].userItems={}),_.userPayments.forEach(p=>{let M=p.userId;this.orderHistory[x].userItems[M]?this.orderHistory[x].userItems[M].isPaid=p.status===2:this.orderHistory[x].userItems[M]={userName:p.userName||"Unknown User",items:[],totalAmount:p.amount||0,deliveryFee:0,isPaid:p.status===2}}))}c++,c===m&&(this.isLoading=!1)},error:_=>{console.error(`Error fetching payment statuses for order ${s.id}:`,_),c++,c===m&&(this.isLoading=!1)}})})},error:r=>{this.isLoading=!1,this.errorMessage=r.message||"Failed to load order history"}})}showCloseOrderConfirmation(r){r.restaurantName!==void 0?this.orderToClose={id:r.id,restaurantId:"",managerId:"",status:r.status,orderDate:r.orderDate,closedAt:r.closedAt,restaurant:{id:"",name:r.restaurantName,description:"",address:"",phoneNumber:"",deliveryFee:r.deliveryFee||0}}:this.orderToClose=r}cancelCloseOrder(){this.orderToClose=null}confirmCloseOrder(){if(!this.orderToClose)return;this.isProcessingClose=!0,this.errorMessage="";let r=this.orderToClose.id,e=this.orderToClose.restaurantId;this.orderService.closeOrder(this.orderToClose.id).subscribe({next:()=>{this.successMessage="Order closed successfully",this.isProcessingClose=!1;let n=this.orderToClose?.id;this.orderToClose=null,e&&this.restaurantsWithActiveOrders.delete(e),this.loadActiveOrders(),this.loadOrderHistory(),this.selectedOrder&&this.selectedOrder.id===n&&this.viewOrderDetails(this.selectedOrder)},error:n=>{this.isProcessingClose=!1,this.errorMessage=n.message||"Failed to close order"}})}viewOrderDetails(r){if(this.isLoadingDetails=!0,this.errorMessage="",r.restaurantName!==void 0){if(this.selectedOrder=w(E({},r),{id:r.id,restaurantId:"",managerId:"",status:r.status,orderDate:r.orderDate,closedAt:r.closedAt,restaurant:{id:"",name:r.restaurantName,description:"",address:"",phoneNumber:"",deliveryFee:r.deliveryFee||0},deliveryFee:r.deliveryFee}),r.userItems&&Array.isArray(r.userItems)&&r.userItems.length>0){console.log("Processing embedded userItems from order",r.userItems);let e={},n=0,o=r.deliveryFee||0;r.userItems.forEach(m=>{let s=m.userId,_=m.userName||"Unknown User",S=m.price||0,x=m.total||S*m.quantity;n+=x,e[s]||(e[s]={userName:_,items:[],totalAmount:0,deliveryFee:0,isPaid:!1});let p={id:m.id,orderId:r.id,userId:m.userId,menuItemId:m.menuItemId||"",quantity:m.quantity,note:m.note,menuItem:{id:m.menuItemId||"",name:m.menuItemName,description:"",price:m.price,restaurantId:""},user:{id:m.userId,name:m.userName,email:""}};e[s].items.push(p),e[s].totalAmount+=x});let c=Object.keys(e).length;if(c>0&&o>0){let m=r.deliveryFeeShare||o/c;Object.keys(e).forEach(s=>{e[s].deliveryFee=m,e[s].totalAmount+=m}),n+=o}this.selectedOrder.userItems=e,this.selectedOrder.totalAmount=n,this.selectedOrder.deliveryFee=o,r.status===2?this.orderService.getOrderPaymentStatuses(r.id).subscribe({next:m=>{console.log("Payment statuses response:",m),m&&m.userPayments&&Array.isArray(m.userPayments)&&m.userPayments.forEach(s=>{s.userId&&e[s.userId]&&(e[s.userId].isPaid=s.status===2)}),this.isLoadingDetails=!1},error:m=>{console.error("Error fetching payment statuses:",m),this.isLoadingDetails=!1}}):this.isLoadingDetails=!1;return}}else this.selectedOrder=E({},r);this.orderService.getAllOrderItems(r.id).subscribe({next:e=>{if(e.items&&Array.isArray(e.items)){console.log("Received new API response format",e),e.restaurantName&&(this.selectedOrder.restaurant?(this.selectedOrder.restaurant.name=e.restaurantName,this.selectedOrder.restaurant.deliveryFee=e.deliveryFee||0):this.selectedOrder.restaurant={id:"",name:e.restaurantName,description:"",address:"",phoneNumber:"",deliveryFee:e.deliveryFee||0});let n={},o=0,c=e.deliveryFee||0;e.items.forEach(s=>{let _=s.userId,S=s.userName||"Unknown User",x=s.price||0,p=s.itemTotal||x*s.quantity;o+=p,n[_]||(n[_]={userName:S,items:[],totalAmount:0,deliveryFee:0,isPaid:!1});let M={id:s.id,orderId:e.orderId||r.id,userId:s.userId,menuItemId:s.menuItemId,quantity:s.quantity,note:s.note,menuItem:{id:s.menuItemId,name:s.menuItemName,description:s.menuItemDescription,price:s.price,restaurantId:""},user:{id:s.userId,name:s.userName,email:""}};n[_].items.push(M),n[_].totalAmount+=p});let m=Object.keys(n).length;if(m>0&&c>0){let s=c/m;Object.keys(n).forEach(_=>{n[_].deliveryFee=s,n[_].totalAmount+=s}),o+=c}this.selectedOrder.userItems=n,this.selectedOrder.totalAmount=o,this.selectedOrder.deliveryFee=c,r.status===2?this.orderService.getOrderPaymentStatuses(r.id).subscribe({next:s=>{console.log("Payment statuses response:",s),s&&s.userPayments&&Array.isArray(s.userPayments)&&s.userPayments.forEach(_=>{_.userId&&n[_.userId]&&(n[_.userId].isPaid=_.status===2)}),this.isLoadingDetails=!1},error:s=>{console.error("Error fetching payment statuses:",s),this.isLoadingDetails=!1}}):this.isLoadingDetails=!1}else{let n=e,o={},c=0;n.forEach(m=>{let s=m.userId,_=m.user?.name||"Unknown User",x=(m.menuItem?.price||0)*m.quantity;c+=x,o[s]||(o[s]={userName:_,items:[],totalAmount:0,deliveryFee:0,isPaid:!1}),o[s].items.push(m),o[s].totalAmount+=x}),this.selectedOrder.userItems=o,this.selectedOrder.totalAmount=c,r.status===2?this.orderService.getOrderPaymentStatuses(r.id).subscribe({next:m=>{console.log("Payment statuses response:",m),m&&m.userPayments&&Array.isArray(m.userPayments)&&m.userPayments.forEach(s=>{s.userId&&o[s.userId]&&(o[s.userId].isPaid=s.status===2)}),this.isLoadingDetails=!1},error:m=>{console.error("Error fetching payment statuses:",m),this.isLoadingDetails=!1}}):this.isLoadingDetails=!1}},error:e=>{this.isLoadingDetails=!1,this.errorMessage=e.message||"Failed to load order details"}})}updatePaymentStatus(r,e,n){this.processingPayment=!0,this.errorMessage="",console.log(`Updating payment status: orderId=${r}, userId=${e}, status=${n}`),this.orderService.updatePaymentStatus(r,e,n).subscribe({next:o=>{console.log("Payment status update response:",o),this.successMessage="Payment status updated successfully",this.orderService.getOrderPaymentStatuses(r).subscribe({next:c=>{console.log("Updated payment statuses:",c),c&&c.userPayments&&Array.isArray(c.userPayments)&&this.selectedOrder&&this.selectedOrder.userItems&&c.userPayments.forEach(s=>{s.userId&&this.selectedOrder.userItems[s.userId]&&(this.selectedOrder.userItems[s.userId].isPaid=s.status===2)});let m=this.orderHistory.findIndex(s=>s.id===r);m!==-1&&(this.orderHistory[m].userItems||(this.orderHistory[m].userItems={}),c&&c.userPayments&&Array.isArray(c.userPayments)&&c.userPayments.forEach(s=>{let _=s.userId;this.orderHistory[m].userItems[_]?this.orderHistory[m].userItems[_].isPaid=s.status===2:this.orderHistory[m].userItems[_]={userName:s.userName||"Unknown User",items:[],totalAmount:s.amount||0,deliveryFee:0,isPaid:s.status===2}})),this.processingPayment=!1},error:c=>{console.error("Error fetching updated payment statuses:",c),this.processingPayment=!1}})},error:o=>{console.error("Error updating payment status:",o),this.processingPayment=!1,this.errorMessage=o.message||"Failed to update payment status"}})}clearSelectedOrder(){this.selectedOrder=null}startNewOrder(){if(!this.selectedRestaurantId){this.errorMessage="Please select a restaurant first";return}if(this.restaurantsWithActiveOrders.has(this.selectedRestaurantId)){this.errorMessage="This restaurant already has an active order";return}this.isCreatingOrder=!0,this.errorMessage="",this.orderService.startOrder(this.selectedRestaurantId,this.authService.currentUser?.id).subscribe({next:r=>{this.isCreatingOrder=!1,this.successMessage="Order started successfully",this.restaurantsWithActiveOrders.add(this.selectedRestaurantId),this.loadActiveOrders()},error:r=>{this.isCreatingOrder=!1,this.errorMessage=r.message||"Failed to start new order"}})}getOrderStatusName(r){switch(r){case 1:return"Open";case 2:return"Closed";default:return"Unknown"}}getOrderStatusClass(r){switch(r){case 1:return"bg-success";case 2:return"bg-secondary";default:return"bg-secondary"}}formatDate(r){return r?new Date(r).toLocaleString():"N/A"}static \u0275fac=function(e){return new(e||d)(P(Z),P($),P(J),P(W))};static \u0275cmp=A({type:d,selectors:[["app-manager-order-management"]],decls:31,vars:10,consts:[["noItems",""],[1,"container","py-4"],[1,"d-flex","justify-content-between","align-items-center","mb-4"],["class","alert alert-danger alert-dismissible fade show","role","alert",4,"ngIf"],["class","alert alert-success alert-dismissible fade show","role","alert",4,"ngIf"],["class","d-flex justify-content-center my-5",4,"ngIf"],[1,"card","mb-4"],[1,"card-header","bg-primary","text-white"],[1,"mb-0"],[1,"card-body"],[1,"row"],[1,"col-md-6"],[1,"mb-3"],["for","restaurantSelect",1,"form-label"],["id","restaurantSelect",1,"form-select",3,"ngModelChange","ngModel"],["value",""],[3,"value","disabled",4,"ngFor","ngForOf"],[1,"btn","btn-primary",3,"click","disabled"],["class","spinner-border spinner-border-sm me-2","role","status","aria-hidden","true",4,"ngIf"],["class","confirmation-modal-overlay",4,"ngIf"],["class","order-details-overlay",4,"ngIf"],[4,"ngIf"],[1,"mt-4"],["routerLink","/",1,"btn","btn-secondary"],[1,"fas","fa-arrow-left","me-2"],["role","alert",1,"alert","alert-danger","alert-dismissible","fade","show"],["type","button",1,"btn-close",3,"click"],["role","alert",1,"alert","alert-success","alert-dismissible","fade","show"],[1,"d-flex","justify-content-center","my-5"],["role","status",1,"spinner-border","text-primary"],[1,"visually-hidden"],[3,"value","disabled"],["role","status","aria-hidden","true",1,"spinner-border","spinner-border-sm","me-2"],[1,"confirmation-modal-overlay"],[1,"confirmation-modal"],[1,"modal-header"],[1,"modal-title"],[1,"modal-body"],[1,"alert","alert-warning"],[1,"fas","fa-exclamation-triangle","me-2"],[1,"order-info","mt-3"],[1,"modal-footer"],["type","button",1,"btn","btn-secondary",3,"click"],["type","button",1,"btn","btn-danger",3,"click","disabled"],[1,"order-details-overlay"],[1,"order-details-modal"],[1,"badge","ms-2",3,"ngClass"],["class","d-flex justify-content-center my-4",4,"ngIf"],["type","button","class","btn btn-danger",3,"click",4,"ngIf"],[1,"d-flex","justify-content-center","my-4"],[1,"order-info","mb-4"],[4,"ngIf","ngIfElse"],["class","user-order-section mb-4",4,"ngFor","ngForOf"],[1,"card","mt-4"],[1,"card-header"],[1,"col-md-6","offset-md-6"],[1,"table"],[1,"text-end"],[1,"fw-bold"],[1,"user-order-section","mb-4"],[1,"card"],[1,"card-header","d-flex","justify-content-between","align-items-center"],[1,"badge","me-2",3,"ngClass"],["class","btn btn-sm btn-success",3,"disabled","click",4,"ngIf"],["class","btn btn-sm btn-warning",3,"disabled","click",4,"ngIf"],[1,"table-responsive"],[1,"table","table-sm"],[4,"ngFor","ngForOf"],["class","delivery-fee-row",4,"ngIf"],["colspan","3",1,"text-end"],[1,"btn","btn-sm","btn-success",3,"click","disabled"],[1,"fas","fa-check","me-1"],[1,"btn","btn-sm","btn-warning",3,"click","disabled"],[1,"fas","fa-times","me-1"],[1,"delivery-fee-row"],["colspan","3",1,"text-end","fw-bold"],[1,"alert","alert-info"],["type","button",1,"btn","btn-danger",3,"click"],[1,"card-header","bg-success","text-white"],["class","alert alert-info",4,"ngIf"],["class","table-responsive",4,"ngIf"],[1,"card-header","bg-secondary","text-white"],[1,"table","table-hover"],["role","group",1,"btn-group"],[1,"btn","btn-sm","btn-primary",3,"click"],[1,"fas","fa-eye","me-1"],[1,"btn","btn-sm","btn-danger",3,"click"],[1,"fas","fa-times-circle","me-1"]],template:function(e,n){e&1&&(i(0,"div",1)(1,"div",2)(2,"h1"),a(3,"Order Management"),t()(),f(4,te,3,1,"div",3)(5,re,3,1,"div",4)(6,ie,4,0,"div",5),i(7,"div",6)(8,"div",7)(9,"h2",8),a(10,"Start New Order"),t()(),i(11,"div",9)(12,"div",10)(13,"div",11)(14,"div",12)(15,"label",13),a(16,"Select Any Restaurant"),t(),i(17,"select",14),D("ngModelChange",function(c){return k(n.selectedRestaurantId,c)||(n.selectedRestaurantId=c),c}),i(18,"option",15),a(19,"-- Select Restaurant --"),t(),f(20,ne,2,4,"option",16),t()(),i(21,"button",17),h("click",function(){return n.startNewOrder()}),f(22,ae,1,0,"span",18),a(23," Start New Order "),t()()()()(),f(24,de,31,5,"div",19)(25,ye,15,5,"div",20)(26,Ee,15,4,"div",21),i(27,"div",22)(28,"a",23),b(29,"i",24),a(30,"Back to Home "),t()()()),e&2&&(l(4),g("ngIf",n.errorMessage),l(),g("ngIf",n.successMessage),l(),g("ngIf",n.isLoading),l(11),T("ngModel",n.selectedRestaurantId),l(3),g("ngForOf",n.managedRestaurants),l(),g("disabled",!n.selectedRestaurantId||n.isCreatingOrder),l(),g("ngIf",n.isCreatingOrder),l(2),g("ngIf",n.orderToClose),l(),g("ngIf",n.selectedOrder),l(),g("ngIf",!n.isLoading))},dependencies:[U,L,R,H,G,Y,Q,z,q,B,j],styles:[".confirmation-modal-overlay[_ngcontent-%COMP%], .order-details-overlay[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;z-index:1050;display:flex;align-items:center;justify-content:center}.confirmation-modal[_ngcontent-%COMP%], .order-details-modal[_ngcontent-%COMP%]{background-color:#fff;border-radius:5px;width:90%;max-width:800px;max-height:90vh;overflow-y:auto;animation:_ngcontent-%COMP%_modalFadeIn .3s}.order-details-modal[_ngcontent-%COMP%]{width:95%;max-width:1000px}@keyframes _ngcontent-%COMP%_modalFadeIn{0%{opacity:0;transform:translateY(-50px)}to{opacity:1;transform:translateY(0)}}.modal-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid #dee2e6}.modal-body[_ngcontent-%COMP%]{padding:1rem}.modal-footer[_ngcontent-%COMP%]{padding:1rem;border-top:1px solid #dee2e6;display:flex;justify-content:flex-end;gap:.5rem}.delivery-fee-row[_ngcontent-%COMP%]{background-color:#f8f9fa}.user-order-section[_ngcontent-%COMP%]:not(:last-child){margin-bottom:2rem}"]})};export{ee as ManagerOrderManagementComponent};
